#!/usr/bin/env ruby

# frozen_string_literal: true

require 'fog/openstack'
require 'openstack_taster'

auth_url = String.new(ENV['OS_AUTH_URL'])
auth_url << '/tokens' unless auth_url.end_with?('tokens')
auth_url.freeze

OPENSTACK_CREDS = {
  openstack_auth_url: auth_url,
  openstack_username: ENV['OS_USERNAME'],
  openstack_tenant:   ENV['OS_TENANT_NAME'],
  openstack_api_key:  ENV['OS_PASSWORD']
}.freeze

SSH_KEYS = {
  keypair: ENV['OS_SSH_KEYPAIR'],
  private_key: ENV['OS_PRIVATE_SSH_KEY'],
  public_key: ENV['OS_PUBLIC_SSH_KEY'] # REVIEW
}.freeze

controller_host = auth_url.split(':')[1].delete('//')
LOG_DIR = "logs/#{controller_host}"

compute = Fog::Compute::OpenStack.new(OPENSTACK_CREDS)
volume  = Fog::Volume::OpenStack.new(OPENSTACK_CREDS)
image   = Fog::Image::OpenStack.new(OPENSTACK_CREDS)
network = Fog::Network::OpenStack.new(OPENSTACK_CREDS)

OpenStackTaster.new(
  compute, volume, image, network,
  SSH_KEYS, LOG_DIR
).taste_all
